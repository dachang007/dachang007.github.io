<!DOCTYPE html><html lang="zh-cn" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>Redis系列：使用Streams实现消息队列 | 数根朽木，</title><meta name="keywords" content="Redis,Stream实现消息队列"><meta name="author" content="dachang"><meta name="copyright" content="dachang"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#F9F9F9"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Redis系列：使用Streams实现消息队列"><meta name="application-name" content="Redis系列：使用Streams实现消息队列"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#F9F9F9"><meta property="og:type" content="article"><meta property="og:title" content="Redis系列：使用Streams实现消息队列"><meta property="og:url" content="https://yeoh.de5.net/2025/03/11/Redis%E7%B3%BB%E5%88%97/Redis%E7%B3%BB%E5%88%97-%E4%BD%BF%E7%94%A8Stream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%20%EF%BC%88%E5%9B%BE%E6%96%87%E6%80%BB%E7%BB%93+Go%E6%A1%88%E4%BE%8B%EF%BC%89/index.html"><meta property="og:site_name" content="数根朽木，"><meta property="og:description" content="1 先导我们在《Redis系列：使用List实现消息队列 | 数根朽木，》这一篇中详细讨论了如何使用List实现消息队列，但同时也看到很多局限性，比如：  不支持消息确认机制，没有很好的ACK应答 不支持消息回溯，无法排查问题和做消息分析 List按照FIFO机制执行，所以存在消息堆积的风险。 查询"><meta property="og:locale" content="zh-cn"><meta property="og:image" content="https://imags-563.pages.dev/file/AgACAgUAAxkDAAIBFWlIvNvdTt-H8sSGtUfWAtXH1LFZAAJjDGsbp6dAVpJ4P2lUtyBqAQADAgADeAADNgQ.png"><meta property="article:author" content="dachang"><meta property="article:tag" content="blog, coding, technology, personal"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://imags-563.pages.dev/file/AgACAgUAAxkDAAIBFWlIvNvdTt-H8sSGtUfWAtXH1LFZAAJjDGsbp6dAVpJ4P2lUtyBqAQADAgADeAADNgQ.png"><meta name="description" content="1 先导我们在《Redis系列：使用List实现消息队列 | 数根朽木，》这一篇中详细讨论了如何使用List实现消息队列，但同时也看到很多局限性，比如：  不支持消息确认机制，没有很好的ACK应答 不支持消息回溯，无法排查问题和做消息分析 List按照FIFO机制执行，所以存在消息堆积的风险。 查询"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://yeoh.de5.net/2025/03/11/Redis%E7%B3%BB%E5%88%97/Redis%E7%B3%BB%E5%88%97-%E4%BD%BF%E7%94%A8Stream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%20%EF%BC%88%E5%9B%BE%E6%96%87%E6%80%BB%E7%BB%93+Go%E6%A1%88%E4%BE%8B%EF%BC%89/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: undefined,
  diytitle: undefined,
  LA51: {"enable":true,"ck":null,"LingQueMonitorID":null},
  greetingBox: undefined,
  twikooEnvId: 'https://twikoo-kohl-zeta.vercel.app',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: undefined,
  friends_vue_info: undefined,
  navMusic: false,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"该文章距离上次更新已经过去","messageNext":"天了，文章内容可能已经过时，注意甄别。"},
  highlight: {"plugin":"highlight.js","highlightCopy":false,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: dachang","link":"链接: ","source":"来源: 数根朽木，","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '数根朽木，',
  title: 'Redis系列：使用Streams实现消息队列',
  postAI: '',
  pageFillDescription: '1 先导, 2 关于Stream, 3 主要命令, 3.1 XADD 消息记录, 3.1.1 XADD 命令的基本语法, 3.1.2 XADD 示例, 3.1.3 有啥需要注意的呢, 3.2 XREAD 消息消费, 3.2.1 XREAD 命令的基本语法, 3.2.2 XREAD 示例, 3.2.3 需要注意啥呢？, 3.3 Consumer Group 消费组模式, 3.3.1 创建消费者组, 3.3.2 读取消息, 3.3.3 确认消息, 3.3.4 PLE：消息可靠性保障, 4 使用Golang实现Stream队列能力, 4.1 先安装go-redisx2Fredis库, 逻辑实现, 5 应用场景, 6 总结先导我们在系列使用实现消息队列数根朽木这一篇中详细讨论了如何使用实现消息队列但同时也看到很多局限性比如不支持消息确认机制没有很好的应答不支持消息回溯无法排查问题和做消息分析按照机制执行所以存在消息堆积的风险查询效率低作为线性结构中定位一个数据需要进行遍历的时间复杂度不存在消费组的概念无法实现多个消费者组成分组进行消费关于是版本中引入的一种新的数据结构它主要用于高效地处理流式数据特别适用于消息队列日志记录和实时数据分析等场景以下是对的主要特征数据结构是一个由有序消息组成的日志数据结构每个消息都有一个全局唯一的确保消息的顺序性和可追踪性消息消息的由两部分组成分别是毫秒级时间戳和序列号这种设计确保了消息的单调递增性即新消息的总是大于旧消息的消费者组支持消费者组的概念允许多个消费者以组的形式订阅并且每个消息只会被组内的一个消费者处理避免了消息的重复消费以及主要优势持久化存储中的消息可以被持久化存储确保数据不会丢失即使在服务器重启后也能恢复消息有序性消息按照产生顺序生成消息被添加到中并且可以按照指定的条件检索消息保证了消息的有序性多播与分组消费支持多个消费者同时消费同一流中的消息并且可以将消费者组织成消费组实现消息的分组消费消息确认机制消费者可以通过命令确认是否成功消费消息保证消息至少背消费一次确保消息不会被重复处理阻塞读取消费者可以选择阻塞读取模式当没有新消息时消费者会等待直至新消息到达消息可回溯方便补数特殊数据处理以及问题回溯查询主要命令向中添加消息如果指定的不存在则会自动创建以阻塞非阻塞方式获取中的消息列表从消费者组中读取消息支持阻塞读取确认消费者已经成功处理了消息用于管理消费者组包括创建设置销毁消费者组等操作查询消费者组中的待处理消息消息记录命令用于向流数据结构中添加消息命令的基本语法指定要添加消息的的名字可选参数用于限制的最大长度当的长度达到时旧的消息会被自动删除可选参数用于指定消息的如果不指定该参数会自动生成一个唯一的消息的字段和值消息的内容以的形式存在命令的一个重要用途是实现消息发布功能发布者可以使用命令向中添加消息示例假设我们有一个名为的并希望向其中添加一个包含和字段的消息我们可以使用以下命令在这个例子中表示让自动生成一个唯一的消息消息包含两个字段和它们的值分别是和所以这边记录了一个用户信息姓名为年龄岁有啥需要注意的呢如果指定的不存在命令会创建一个新的消息的是唯一的并且会保证中消息的是单调递增的如果指定了则新消息的必须大于中现有的所有消息的使用参数可以限制的大小这在处理大量消息时非常有用可以避免占用过多的内存或磁盘空间消息消费即将消息从队列中读取出来消费命令的基本语法命令的基本语法如下这是一个可选参数用于指定一次读取的最大消息数量如果不指定默认为这也是一个可选参数用于指定阻塞的时间以毫秒为单位如果指定了阻塞时间并且当前没有可消费的消息客户端将在指定的时间内阻塞等待如果不设置该参数或设置为则命令将立即返回无论是否有可消费的消息这部分指定了要消费的流和对应的起始消息可以一次指定多个流和对应的起始命令的工作机制读取指定之后的消息命令会返回指定之后的消息不包含指定的消息本身如果没有指定或者指定的不存在于流中那么命令将从流的开始或结束处读取消息具体取决于的值如表示从流的开始处读取表示从流的当前最大处读取阻塞读取当设置了参数后如果当前没有可消费的消息客户端将进入阻塞状态直到有新的消息到达或阻塞时间超时这种机制非常适合实现消费者等待生产者产生新消息的场景支持多个流命令支持同时从多个流中读取消息只需在命令中指定多个流和对应的起始即可示例假设我们有一个名为的流并且想要从该流中读取消息以下是一些示例非阻塞读取最新消息这条命令会尝试从流中读取最新的消息如果有的话是一个特殊表示流的当前最大阻塞读取最新消息这条命令会阻塞毫秒等待流中出现新的消息如果在毫秒内有新消息到达则命令会返回该消息否则命令将超时并返回从特定开始读取这条命令会从流中读取大于或等于的消息最多返回数据需要注意啥呢消息的唯一性在中每个消息都有一个全局唯一的消息这个消息由两部分组成时间戳和序列号时间戳表示消息被添加到流中的时间序列号表示在同一时间戳内添加的消息的顺序消费者组虽然命令本身不直接涉及消费者组的概念但还支持消费者组模式允许一组消费者协作消费同一流中的消息在消费者组模式下通常会使用命令而不是命令来读取消息性能考虑命令在读取大量消息时可能会消耗较多的和内存资源因此在实际应用中需要根据实际情况合理设置参数的值避免一次性读取过多消息导致性能问题消费组模式典型的多播模式在实时性要求比较高的场景如果你想加快对消息的处理那这是一个不错的选择我们让队列在逻辑上进行分区用不同的消费组来隔离消费所以消费者组允许多个消费者或协同处理同一个流中的消息每个消费者组维护自己的消费偏移量即已处理消息的位置以支持消费者之间的负载均衡和容错创建消费者组使用命令创建消费者组队列名称消费者组消息开始位置消息结束位置表示从流的当前末尾即最新消息开始创建消费者组如果流不存在选项将自动创建流或者下面是具体实现示例为队列创建了消费组和消费组读取消息消费者可以通过命令从消费者组中读取消息命令不仅读取消息还会更新消费者组中的消费者状态即标记哪些消息已被读取消费者群组名消费者名称消费个数表示如果流中没有新消息则命令将阻塞最多毫秒则无限阻塞队列名称消息消费代表可选参数放在命令参数的最后面表示从尚未被消费的消息开始读取或者下面是具体实现示例消费组的消费者从中以阻塞的方式读取一条消息确认消息处理完消息后消费者需要发送命令来确认消息这告诉这条消息已经被成功处理并且可以从消费者组的待处理消息列表中移除队列名称消费者群组名是要确认的消息的确认两条消息消息可靠性保障记录了当前被消费者读取但尚未确认的消息这些消息在消费者成功处理并发送命令之前会一直保留在中如果消费者崩溃或未能及时发送命令将确保这些消息能够被重新分配给其他消费者进行处理从而实现消息的可靠传递以下的例子中我们查看中的消费组中各个消费者已读取但未确认的消息信息未确认消息条数详细的操作见官网文档使用实现队列能力先安装库注意这里的是库的版本号你可以根据实际情况进行调整逻辑实现连接到地址密码如果有的话使用默认创建创建消费者读取消息阻塞毫秒超时没有新消息确认消息模拟生产者继续发送消息模拟生产间隔注意在实际应用中主通常不会立即退出而是会等待某些触发条件应用场景消息队列可以作为消息队列使用支持消息的发布订阅和消费日志记录将日志信息写入方便后续的查询和分析实时数据分析结合的其他数据结构如等对中的数据进行实时分析总结是在消息队列和流式数据处理领域的一个重要补充它提供了简单但功能强大的数据流处理能力为开发者提供了更多的选择和灵活性相对的优势如下支持消息确认机制应答确认支持消息回溯方便排查问题和做消息分析存在消费组的概念可以进行分组消费和批量消费可以负载多个消费实例',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-12-25 09:45:02',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#1F1F1F')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#F9F9F9')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网站项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://imags-563.pages.dev" title="个人博客"><img class="back-menu-item-icon" src="/favicon.ico" alt="个人博客"/><span class="back-menu-item-text">个人博客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://imags-563.pages.dev" title="在线简历"><img class="back-menu-item-icon" src="/favicon.ico" alt="在线简历"/><span class="back-menu-item-text">在线简历</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">建设工具</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://imags-563.pages.dev" title="在线图床"><img class="back-menu-item-icon" src="/img/image.ico" alt="在线图床"/><span class="back-menu-item-text">在线图床</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="http://greatree.hidns.co" title="在线烟花模拟器"><img class="back-menu-item-icon" src="/img/Clash.Mini.png" alt="在线烟花模拟器"/><span class="back-menu-item-text">在线烟花模拟器</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="http://greatree.hidns.co" title="烟花模拟器"><img class="back-menu-item-icon" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAAMMZ7Qfv1Xv2qvgqSVN7kNhRO_uzfgAAlvAMRtiZKBVrGT1Z6RPiX4BAAMCAANtAAM2BA.png" alt="烟花模拟器"/><span class="back-menu-item-text">烟花模拟器</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="http://pay.totalh.net/" title="三合一收款码"><img class="back-menu-item-icon" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAAM8Z7WNYNdWdrYsas5PPFT8Di3493sAAgLKMRsEtalVDcfaakgTXPkBAAMCAAN4AAM2BA.png" alt="三合一收款码"/><span class="back-menu-item-text">三合一收款码</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">数根朽木，</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 博客文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 全部文章</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 文章分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 所有标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 网站工具</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://imags-563.pages.dev"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 图床工具</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="http://greatree.hidns.co"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size: 0.9em;"></i><span> 烟花模拟器</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://suburl.v1.mk"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 订阅转换</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://imags-563.pages.dev"><span> 在线简历生成</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于我</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://imags-563.pages.dev"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 在线简历</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://imags-563.pages.dev/file/AgACAgUAAxkDAAMEZ7HheDSuPHt4eDeH2L1Y4ORfslsAArXEMRuvMJFVZbGWT1spGtgBAAMCAAN4AAM2BA.jpg" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAAMEZ7HheDSuPHt4eDeH2L1Y4ORfslsAArXEMRuvMJFVZbGWT1spGtgBAAMCAAN4AAM2BA.jpg"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://imags-563.pages.dev/file/AgACAgUAAxkDAAMFZ7Hh6gSTlGPMvEOEIQjcnW85WsUAArfEMRuvMJFV1ctnAAFzfhv0AQADAgADeAADNgQ.jpg" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAAMFZ7Hh6gSTlGPMvEOEIQjcnW85WsUAArfEMRuvMJFV1ctnAAFzfhv0AQADAgADeAADNgQ.jpg"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Boolean-filter/" style="font-size: 1.05rem;">Boolean filter<sup>2</sup></a><a href="/tags/DNS%E6%B3%84%E9%9C%B2/" style="font-size: 1.05rem;">DNS泄露<sup>1</sup></a><a href="/tags/Fake-IP/" style="font-size: 1.05rem;">Fake IP<sup>1</sup></a><a href="/tags/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 1.05rem;">JVM虚拟机<sup>1</sup></a><a href="/tags/Java/" style="font-size: 1.05rem;">Java<sup>1</sup></a><a href="/tags/JavaSE/" style="font-size: 1.05rem;">JavaSE<sup>11</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">Java基础<sup>11</sup></a><a href="/tags/Java%E6%A0%B8%E5%BF%83/" style="font-size: 1.05rem;">Java核心<sup>14</sup></a><a href="/tags/Java%E7%89%88%E6%9C%AC%E6%96%B0%E7%89%B9%E6%80%A7/" style="font-size: 1.05rem;">Java版本新特性<sup>2</sup></a><a href="/tags/MQ/" style="font-size: 1.05rem;">MQ<sup>2</sup></a><a href="/tags/MySQL/" style="font-size: 1.05rem;">MySQL<sup>10</sup></a><a href="/tags/OOM/" style="font-size: 1.05rem;">OOM<sup>1</sup></a><a href="/tags/RabbitMQ/" style="font-size: 1.05rem;">RabbitMQ<sup>2</sup></a><a href="/tags/Redis/" style="font-size: 1.05rem;">Redis<sup>9</sup></a><a href="/tags/Redis%E5%86%85%E5%AD%98%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5/" style="font-size: 1.05rem;">Redis内存淘汰策略<sup>1</sup></a><a href="/tags/Redis%E5%8E%9F%E7%90%86/" style="font-size: 1.05rem;">Redis原理<sup>1</sup></a><a href="/tags/Redis%E7%BC%93%E5%AD%98/" style="font-size: 1.05rem;">Redis缓存<sup>4</sup></a><a href="/tags/RocketMQ/" style="font-size: 1.05rem;">RocketMQ<sup>2</sup></a><a href="/tags/SSM/" style="font-size: 1.05rem;">SSM<sup>1</sup></a><a href="/tags/Spring/" style="font-size: 1.05rem;">Spring<sup>2</sup></a><a href="/tags/SpringBoot/" style="font-size: 1.05rem;">SpringBoot<sup>1</sup></a><a href="/tags/kafka/" style="font-size: 1.05rem;">kafka<sup>2</sup></a><a href="/tags/%E4%BA%8B%E5%8A%A1/" style="font-size: 1.05rem;">事务<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" style="font-size: 1.05rem;">分布式锁<sup>1</sup></a><a href="/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" style="font-size: 1.05rem;">单例模式<sup>1</sup></a><a href="/tags/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/" style="font-size: 1.05rem;">布隆过滤器<sup>2</sup></a><a href="/tags/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98/" style="font-size: 1.05rem;">微信支付<sup>1</sup></a><a href="/tags/%E6%8E%A5%E5%8F%A3%E8%B6%85%E6%97%B6/" style="font-size: 1.05rem;">接口超时<sup>1</sup></a><a href="/tags/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 1.05rem;">消息中间件<sup>2</sup></a><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 1.05rem;">消息队列<sup>2</sup></a><a href="/tags/%E7%BA%BF%E4%B8%8A%E4%BA%8B%E6%95%85/" style="font-size: 1.05rem;">线上事故<sup>1</sup></a><a href="/tags/%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF/" style="font-size: 1.05rem;">缓存击穿<sup>2</sup></a><a href="/tags/%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9/" style="font-size: 1.05rem;">缓存雪崩<sup>2</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E4%BC%98%E5%8C%96/" style="font-size: 1.05rem;">网络优化<sup>1</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 1.05rem;">设计模式<sup>1</sup></a><a href="/tags/%E8%BF%90%E7%BB%B4%E8%B0%83%E4%BC%98/" style="font-size: 1.05rem;">运维调优<sup>4</sup></a><a href="/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/" style="font-size: 1.05rem;">高并发<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">19</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">13</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">10</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/Redis/" itemprop="url">Redis</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Redis/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Redis</span></a><a class="article-meta__tags" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>消息队列</span></a></span></div></div><h1 class="post-title" itemprop="name headline">Redis系列：使用Streams实现消息队列</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-03-11T13:18:24.000Z" title="发表于 2025-03-11 21:18:24">2025-03-11</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-12-25T01:45:02.971Z" title="更新于 2025-12-25 09:45:02">2025-12-25</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">3.8k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>13分钟</span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为深圳"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>深圳</span></div></div></div><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAAIBFWlIvNvdTt-H8sSGtUfWAtXH1LFZAAJjDGsbp6dAVpJ4P2lUtyBqAQADAgADeAADNgQ.png"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://yeoh.de5.net/2025/03/11/Redis%E7%B3%BB%E5%88%97/Redis%E7%B3%BB%E5%88%97-%E4%BD%BF%E7%94%A8Stream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%20%EF%BC%88%E5%9B%BE%E6%96%87%E6%80%BB%E7%BB%93+Go%E6%A1%88%E4%BE%8B%EF%BC%89/"><header><a class="post-meta-categories" href="/categories/Redis/" itemprop="url">Redis</a><a href="/tags/Redis/" tabindex="-1" itemprop="url">Redis</a><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" tabindex="-1" itemprop="url">消息队列</a><h1 id="CrawlerTitle" itemprop="name headline">Redis系列：使用Streams实现消息队列</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">dachang</span><time itemprop="dateCreated datePublished" datetime="2025-03-11T13:18:24.000Z" title="发表于 2025-03-11 21:18:24">2025-03-11</time><time itemprop="dateCreated datePublished" datetime="2025-12-25T01:45:02.971Z" title="更新于 2025-12-25 09:45:02">2025-12-25</time></header><h1 id="1-先导"><a href="#1-先导" class="headerlink" title="1 先导"></a>1 先导</h1><p>我们在《<a target="_blank" rel="noopener" href="https://yeoh.qzz.io/2025/03/11/Redis%E7%B3%BB%E5%88%97/Redis%E7%B3%BB%E5%88%97-%E4%BD%BF%E7%94%A8List%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">Redis系列：使用List实现消息队列 | 数根朽木，</a>》这一篇中详细讨论了如何使用List实现消息队列，但同时也看到很多局限性，比如：</p>
<ul>
<li>不支持消息确认机制，没有很好的ACK应答</li>
<li>不支持消息回溯，无法排查问题和做消息分析</li>
<li>List按照FIFO机制执行，所以存在消息堆积的风险。</li>
<li>查询效率低，作为线性结构，List中定位一个数据需要进行遍历，O(N)的时间复杂度</li>
<li>不存在消费组（Consumer Group）的概念，无法实现多个消费者组成分组进行消费</li>
</ul>
<h1 id="2-关于Stream"><a href="#2-关于Stream" class="headerlink" title="2 关于Stream"></a>2 关于Stream</h1><p>Redis Stream是Redis 5.0版本中引入的一种新的数据结构，它主要用于高效地处理流式数据，特别适用于消息队列、日志记录和实时数据分析等场景。<br>以下是对Redis Stream的 主要特征：</p>
<p><strong>1. 数据结构</strong>：Redis Stream是一个由有序消息组成的日志数据结构，每个消息都有一个全局唯一的ID，确保消息的顺序性和可追踪性。</p>
<p><strong>2. 消息ID</strong>：消息的ID由两部分组成，分别是毫秒级时间戳和序列号。这种设计确保了消息ID的单调递增性，即新消息的ID总是大于旧消息的ID。</p>
<p><strong>3. 消费者组</strong>：Redis Stream支持消费者组的概念，允许多个消费者以组的形式订阅Stream，并且每个消息只会被组内的一个消费者处理，避免了消息的重复消费。</p>
<p><strong>以及主要优势:</strong></p>
<ol>
<li>**持久化存储：**Stream中的消息可以被持久化存储，确保数据不会丢失，即使在Redis服务器重启后也能恢复消息.</li>
<li>**有序性：**消息按照产生顺序生成消息ID, 被添加到Stream中，并且可以按照指定的条件检索消息，保证了消息的有序性。</li>
<li><strong>多播与分组消费</strong>：支持多个消费者同时消费同一流中的消息，并且可以将消费者组织成消费组，实现消息的分组消费。</li>
<li>**消息确认机制：**消费者可以通过XACK命令确认是否成功消费消息，保证消息至少背消费一次,确保消息不会被重复处理。</li>
<li>**阻塞读取：**消费者可以选择阻塞读取模式，当没有新消息时，消费者会等待直至新消息到达。</li>
<li><strong>消息可回溯:</strong> 方便补数、特殊数据处理, 以及问题回溯查询</li>
</ol>
<h1 id="3-主要命令"><a href="#3-主要命令" class="headerlink" title="3 主要命令"></a>3 主要命令</h1><p><strong>1. XADD</strong>：向Stream中添加消息。如果指定的Stream不存在，则会自动创建。</p>
<p><strong>2. XREAD</strong>：以阻塞&#x2F;非阻塞方式获取Stream中的消息列表。</p>
<p><strong>3. XREADGROUP</strong>：从消费者组中读取消息，支持阻塞读取。</p>
<p><strong>4. XACK</strong>：确认消费者已经成功处理了消息。</p>
<p><strong>5. XGROUP</strong>：用于管理消费者组，包括创建、设置ID、销毁消费者组等操作。</p>
<p><strong>6. XPENDING</strong>：查询消费者组中的待处理消息。</p>
<h2 id="3-1-XADD-消息记录"><a href="#3-1-XADD-消息记录" class="headerlink" title="3.1 XADD 消息记录"></a>3.1 XADD 消息记录</h2><p>XADD命令用于向Redis Stream（流）数据结构中添加消息。</p>
<h3 id="3-1-1-XADD-命令的基本语法"><a href="#3-1-1-XADD-命令的基本语法" class="headerlink" title="3.1.1 XADD 命令的基本语法"></a>3.1.1 XADD 命令的基本语法</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XADD stream_name <span class="selector-attr">[MAXLEN maxlen]</span> <span class="selector-attr">[ID id]</span> field1 value1 <span class="selector-attr">[field2 value2 ...]</span></span><br></pre></td></tr></table></figure>

<p><strong>1. stream_name</strong>：指定要添加消息的Stream的名字。</p>
<p><strong>2. MAXLEN maxlen</strong>：可选参数，用于限制Stream的最大长度。当Stream的长度达到maxlen时，旧的消息会被自动删除。</p>
<p><strong>3. ID id</strong>：可选参数，用于指定消息的ID。如果不指定该参数，Redis会自动生成一个唯一的ID。</p>
<p><strong>4. field1 value1 [field2 value2 …]</strong>：消息的字段和值，消息的内容以key-value的形式存在。</p>
<p>XADD命令的一个重要用途是实现消息发布功能，发布者可以使用XADD命令向Stream中添加消息。</p>
<h3 id="3-1-2-XADD-示例"><a href="#3-1-2-XADD-示例" class="headerlink" title="3.1.2 XADD 示例"></a>3.1.2 XADD 示例</h3><p>假设我们有一个名为<code>userinfo_stream</code>的Stream，并希望向其中添加一个包含<code>sensor_id</code>和<code>temperature</code>字段的消息，我们可以使用以下命令：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">XADD</span> userinfo_stream * user_name brand age <span class="number">18</span></span><br></pre></td></tr></table></figure>

<p>在这个例子中，<code>*</code>表示让Redis自动生成一个唯一的消息ID。消息包含两个字段：<code>username</code>和<code>age</code>，它们的值分别是<code>brand</code>和<code>18</code>。所以这边记录了一个用户信息，姓名为<code>brand</code>， 年龄<code>18</code>岁。</p>
<h3 id="3-1-3-有啥需要注意的呢"><a href="#3-1-3-有啥需要注意的呢" class="headerlink" title="3.1.3 有啥需要注意的呢"></a>3.1.3 有啥需要注意的呢</h3><ul>
<li>如果指定的Stream<strong>不存在</strong>，XADD命令会<strong>创建一个新的Stream</strong>。</li>
<li>消息的ID是唯一的，并且Redis会保证Stream中消息的ID是单调递增的。如果指定了ID，则新消息的ID必须大于Stream中现有的所有消息的ID。</li>
<li>使用MAXLEN参数可以限制Stream的大小，这在处理大量消息时非常有用，可以避免Stream占用过多的内存或磁盘空间。</li>
</ul>
<h2 id="3-2-XREAD-消息消费"><a href="#3-2-XREAD-消息消费" class="headerlink" title="3.2 XREAD 消息消费"></a>3.2 XREAD 消息消费</h2><p>即将消息从队列中读取出来（消费）</p>
<h3 id="3-2-1-XREAD-命令的基本语法"><a href="#3-2-1-XREAD-命令的基本语法" class="headerlink" title="3.2.1 XREAD 命令的基本语法"></a>3.2.1 XREAD 命令的基本语法</h3><p>XREAD命令的基本语法如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XREAD <span class="selector-attr">[COUNT count]</span> <span class="selector-attr">[BLOCK milliseconds]</span> STREAMS key <span class="selector-attr">[key ...]</span> ID <span class="selector-attr">[ID ...]</span></span><br></pre></td></tr></table></figure>

<p><strong>1. COUNT count</strong>：这是一个可选参数，用于指定一次读取的最大消息数量。如果不指定，默认为1。</p>
<p><strong>2. BLOCK milliseconds</strong>：这也是一个可选参数，用于指定阻塞的时间（以毫秒为单位）。如果指定了阻塞时间，并且当前没有可消费的消息，客户端将在指定的时间内阻塞等待。如果不设置该参数或设置为0，则命令将立即返回，无论是否有可消费的消息。</p>
<p><strong>3. STREAMS key [key …] ID [ID …]</strong>：这部分指定了要消费的流（Streams）和对应的起始消息ID。可以一次指定多个流和对应的起始ID。</p>
<p><strong>XREAD命令的工作机制</strong></p>
<p><strong>1. 读取指定ID之后的消息</strong>：XREAD命令会返回指定ID之后的消息（不包含指定ID的消息本身）。如果没有指定ID，或者指定的ID不存在于流中，那么命令将从流的开始或结束处读取消息，具体取决于ID的值（如“0-0”表示从流的开始处读取，“$”表示从流的当前最大ID处读取）。</p>
<p><strong>2. 阻塞读取</strong>：当设置了BLOCK参数后，如果当前没有可消费的消息，客户端将进入阻塞状态，直到有新的消息到达或阻塞时间超时。这种机制非常适合实现消费者等待生产者产生新消息的场景。</p>
<p><strong>3. 支持多个流</strong>：XREAD命令支持同时从多个流中读取消息，只需在命令中指定多个流和对应的起始ID即可。</p>
<h3 id="3-2-2-XREAD-示例"><a href="#3-2-2-XREAD-示例" class="headerlink" title="3.2.2 XREAD 示例"></a>3.2.2 XREAD 示例</h3><p>假设我们有一个名为<code>userinfo_stream</code>的流，并且想要从该流中读取消息。以下是一些示例：<br><strong>1. 非阻塞读取最新消息</strong>：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">XREAD</span> <span class="variable constant_">COUNT</span> <span class="number">1</span> <span class="variable constant_">STREAMS</span> userinfo_stream $</span><br></pre></td></tr></table></figure>

<p>这条命令会尝试从<code>userinfo_stream</code>流中读取最新的消息（如果有的话）。<code>$</code>是一个特殊ID，表示流的当前最大ID。</p>
<p><strong>2. 阻塞读取最新消息</strong>：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XREAD <span class="built_in">COUNT</span> <span class="number">1</span> <span class="keyword">BLOCK </span><span class="number">1000</span> STREAMS userinfo_stream $</span><br></pre></td></tr></table></figure>

<p>这条命令会阻塞1000毫秒，等待<code>userinfo_stream</code>流中出现新的消息。如果在1000毫秒内有新消息到达，则命令会返回该消息；否则，命令将超时并返回nil。</p>
<p><strong>3. 从特定ID开始读取</strong>：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">XREAD <span class="built_in">COUNT</span> <span class="number">2</span> STREAMS userinfo_stream <span class="number">1722159931000</span><span class="number">-0</span></span><br><span class="line"><span class="number">1</span>) <span class="number">1</span>) <span class="string">&quot;userinfo_stream&quot;</span></span><br><span class="line">    <span class="number">2</span>)  <span class="number">1</span>) <span class="number">1</span>) <span class="string">&quot;1722159931000-0&quot;</span></span><br><span class="line">         <span class="number">2</span>) <span class="number">1</span>) <span class="string">&quot;user_name&quot;</span></span><br><span class="line">             <span class="number">2</span>) <span class="string">&quot;brand&quot;</span></span><br><span class="line">             <span class="number">3</span>) <span class="string">&quot;age&quot;</span></span><br><span class="line">             <span class="number">4</span>) <span class="string">&quot;18&quot;</span></span><br></pre></td></tr></table></figure>

<p>这条命令会从<code>userinfo_stream</code>流中读取ID大于或等于<code>1722159931000-0</code>的消息，最多返回数据。</p>
<h3 id="3-2-3-需要注意啥呢？"><a href="#3-2-3-需要注意啥呢？" class="headerlink" title="3.2.3 需要注意啥呢？"></a>3.2.3 需要注意啥呢？</h3><p><strong>1. 消息ID的唯一性</strong>：在Redis Streams中，每个消息都有一个全局唯一的消息ID，这个消息ID由两部分组成：时间戳和序列号。时间戳表示消息被添加到流中的时间，序列号表示在同一时间戳内添加的消息的顺序。</p>
<p><strong>2. 消费者组</strong>：虽然XREAD命令本身不直接涉及消费者组的概念，但Redis Streams还支持消费者组模式，允许一组消费者协作消费同一流中的消息。在消费者组模式下，通常会使用XREADGROUP命令而不是XREAD命令来读取消息。</p>
<p><strong>3. 性能考虑</strong>：XREAD命令在读取大量消息时可能会消耗较多的CPU和内存资源。因此，在实际应用中需要根据实际情况合理设置COUNT参数的值，避免一次性读取过多消息导致性能问题。</p>
<h2 id="3-3-Consumer-Group-消费组模式"><a href="#3-3-Consumer-Group-消费组模式" class="headerlink" title="3.3 Consumer Group 消费组模式"></a>3.3 Consumer Group 消费组模式</h2><p>典型的多播模式，在实时性要求比较高的场景，如果你想加快对消息的处理。那这是一个不错的选择，我们让队列在逻辑上进行分区，用不同的消费组来隔离消费。所以：</p>
<p><img src="https://imags-563.pages.dev/file/AgACAgUAAxkDAAIBFmlIvRJOjaGmLMEWJvm_XI38vxw4AAJkDGsbp6dAVpjka6W8m4ZaAQADAgADdwADNgQ.png"></p>
<p>消费者组允许多个消费者（client 或 process）协同处理同一个流（Stream）中的消息。每个消费者组维护自己的消费偏移量（即已处理消息的位置），以支持消费者之间的负载均衡和容错。</p>
<h3 id="3-3-1-创建消费者组"><a href="#3-3-1-创建消费者组" class="headerlink" title="3.3.1 创建消费者组"></a>3.3.1 创建消费者组</h3><p>使用 XGROUP CREATE 命令创建消费者组。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># stream_name：队列名称</span></span><br><span class="line"><span class="comment"># consumer_group：消费者组</span></span><br><span class="line"><span class="comment"># msgIdStartIndex：消息Id开始位置</span></span><br><span class="line"><span class="comment"># msgIdStartIndex：消息Id结束位置</span></span><br><span class="line"><span class="comment"># $ 表示从流的当前末尾（即最新消息）开始创建消费者组。如果流不存在，MKSTREAM 选项将自动创建流</span></span><br><span class="line"><span class="variable constant_">XGROUP</span> <span class="variable constant_">CREATE</span> stream_name consumer_group msgIdStartIndex-msgIdStartIndex</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line"><span class="variable constant_">XGROUP</span> <span class="variable constant_">CREATE</span> stream_name consumer_group <span class="variable">$ </span><span class="variable constant_">MKSTREAM</span></span><br></pre></td></tr></table></figure>

<p>下面是具体实现示例，为队列 userinfo_stream 创建了消费组1（consumer_group1）和 消费组2（consumer_group2）：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; xgroup <span class="built_in">create</span> userinfo_stream consumer_group1 <span class="number">0</span><span class="number">-0</span></span><br><span class="line">OK</span><br><span class="line">&gt; xgroup <span class="built_in">create</span> userinfo_stream consumer_group2 <span class="number">0</span><span class="number">-0</span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<h3 id="3-3-2-读取消息"><a href="#3-3-2-读取消息" class="headerlink" title="3.3.2 读取消息"></a>3.3.2 读取消息</h3><p>消费者可以通过 <code>XREADGROUP</code> 命令从消费者组中读取消息。<code>XREADGROUP</code> 命令不仅读取消息，还会更新消费者组中的消费者状态，即标记哪些消息已被读取。</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># group_name: 消费者群组名</span></span><br><span class="line"><span class="comment"># consumer_name: 消费者名称</span></span><br><span class="line"><span class="comment"># COUNT number: count 消费个数</span></span><br><span class="line"><span class="comment"># BLOCK ms: 表示如果流中没有新消息，则命令将阻塞最多 xx 毫秒，0则无限阻塞</span></span><br><span class="line"><span class="comment"># stream_name: 队列名称 </span></span><br><span class="line"><span class="comment"># id: 消息消费ID</span></span><br><span class="line"><span class="comment"># []：代表可选参数</span></span><br><span class="line"><span class="comment"># `&gt;`：放在命令参数的最后面，表示从尚未被消费的消息开始读取；</span></span><br><span class="line"></span><br><span class="line">XREADGROUP GROUP group_name consumer_name [<span class="built_in">COUNT</span> number] [<span class="keyword">BLOCK </span>ms] STREAMS stream_name [stream ...] id [id ...]</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">XREADGROUP GROUP group_name consumer_name <span class="built_in">COUNT</span> <span class="number">1</span> <span class="keyword">BLOCK </span><span class="number">2000</span> STREAMS stream_name &gt;</span><br></pre></td></tr></table></figure>

<p>下面是具体实现示例，消费组 consumer_group1 的消费者 consumer1 从 userinfo_stream 中以阻塞的方式读取一条消息：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">XREADGROUP GROUP consumer_group1 consumer1 <span class="built_in">COUNT</span> <span class="number">1</span> <span class="keyword">BLOCK </span><span class="number">0</span> STREAMS userinfo_stream &gt;</span><br><span class="line"><span class="number">1</span>) <span class="number">1</span>) <span class="string">&quot;userinfo_stream&quot;</span></span><br><span class="line">   <span class="number">2</span>) <span class="number">1</span>) <span class="number">1</span>) <span class="string">&quot;1722159931000-0&quot;</span></span><br><span class="line">         <span class="number">2</span>) <span class="number">1</span>) <span class="string">&quot;user_name&quot;</span></span><br><span class="line">            <span class="number">2</span>) <span class="string">&quot;brand&quot;</span></span><br><span class="line">            <span class="number">3</span>) <span class="string">&quot;age&quot;</span></span><br><span class="line">            <span class="number">4</span>) <span class="string">&quot;18&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-3-确认消息"><a href="#3-3-3-确认消息" class="headerlink" title="3.3.3 确认消息"></a>3.3.3 确认消息</h3><p>处理完消息后，消费者需要发送 XACK 命令来确认消息。这告诉 Redis 这条消息已经被成功处理，并且可以从消费者组的待处理消息列表中移除</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># stream_name: 队列名称 </span></span><br><span class="line"><span class="comment"># group_name: 消费者群组名</span></span><br><span class="line"><span class="comment"># &lt;message-id&gt; 是要确认的消息的 ID。</span></span><br><span class="line"></span><br><span class="line">XACK stream_name group_name &lt;message-<span class="built_in">id</span>&gt;</span><br><span class="line"><span class="comment"># ACK 确认两条消息</span></span><br><span class="line">XACK userinfo_stream consumer_group1 <span class="number">1722159931000</span>-<span class="number">0</span> <span class="number">1722159932000</span>-<span class="number">0</span></span><br><span class="line">(integer) <span class="number">2</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-4-PLE：消息可靠性保障"><a href="#3-3-4-PLE：消息可靠性保障" class="headerlink" title="3.3.4 PLE：消息可靠性保障"></a>3.3.4 PLE：消息可靠性保障</h3><p>PEL（Pending Entries List）记录了当前被消费者读取但尚未确认（ACK）的消息。这些消息在消费者成功处理并发送ACK命令之前，会一直保留在PEL中。如果消费者崩溃或未能及时发送ACK命令，Redis将确保这些消息能够被重新分配给其他消费者进行处理，从而实现消息的可靠传递。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XPENDING stream_name group_name</span><br></pre></td></tr></table></figure>

<p>以下的例子中，我们查看 <code>userinfo_stream</code> 中的 消费组 <code>consumer_group1</code> 中各个消费者已读取但未确认的消息信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">XPENDING userinfo_stream consumer_group1</span><br><span class="line">1) (<span class="built_in">integer</span>) 2   <span class="comment"># 未确认消息条数</span></span><br><span class="line">2) <span class="string">&quot;1722159931000-0&quot;</span></span><br><span class="line">3) <span class="string">&quot;1722159932000-0&quot;</span></span><br></pre></td></tr></table></figure>

<p>详细的stream操作见官网文档：<a target="_blank" rel="noopener" href="https://redis.io/docs/data-types/streams-tutorial/">https://redis.io/docs/data-types/streams-tutorial/</a></p>
<h1 id="4-使用Golang实现Stream队列能力"><a href="#4-使用Golang实现Stream队列能力" class="headerlink" title="4 使用Golang实现Stream队列能力"></a>4 使用Golang实现Stream队列能力</h1><h2 id="4-1-先安装go-redis-redis库"><a href="#4-1-先安装go-redis-redis库" class="headerlink" title="4.1 先安装go-redis&#x2F;redis库"></a>4.1 先安装go-redis&#x2F;redis库</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">go</span> get github.com/<span class="keyword">go</span>-redis/redis/v8</span><br><span class="line"><span class="keyword">go</span>: downloading github.com/<span class="keyword">go</span>-redis/redis v6<span class="number">.15</span><span class="number">.9</span>+incompatible</span><br><span class="line"><span class="keyword">go</span>: downloading github.com/<span class="keyword">go</span>-redis/redis/v8 v8<span class="number">.11</span><span class="number">.5</span></span><br><span class="line"><span class="keyword">go</span>: downloading github.com/dgryski/<span class="keyword">go</span>-rendezvous v0<span class="number">.0</span><span class="number">.0</span><span class="number">-20200823014737</span><span class="number">-9</span>f7001d12a5f</span><br><span class="line"><span class="keyword">go</span>: downloading github.com/cespare/xxhash/v2 v2<span class="number">.1</span><span class="number">.2</span></span><br><span class="line"><span class="keyword">go</span>: added github.com/cespare/xxhash/v2 v2<span class="number">.1</span><span class="number">.2</span></span><br><span class="line"><span class="keyword">go</span>: added github.com/dgryski/<span class="keyword">go</span>-rendezvous v0<span class="number">.0</span><span class="number">.0</span><span class="number">-20200823014737</span><span class="number">-9</span>f7001d12a5f</span><br><span class="line"><span class="keyword">go</span>: added github.com/<span class="keyword">go</span>-redis/redis/v8 v8<span class="number">.11</span><span class="number">.5</span></span><br></pre></td></tr></table></figure>

<p>注意：这里的v8是库的版本号，你可以根据实际情况进行调整</p>
<h2 id="逻辑实现"><a href="#逻辑实现" class="headerlink" title="逻辑实现"></a>逻辑实现</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">	<span class="string">&quot;context&quot;</span>  </span><br><span class="line">	<span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">	<span class="string">&quot;log&quot;</span>  </span><br><span class="line">	<span class="string">&quot;time&quot;</span>  </span><br><span class="line">  </span><br><span class="line">	<span class="string">&quot;github.com/go-redis/redis/v8&quot;</span>  </span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">	<span class="comment">// 连接到Redis  </span></span><br><span class="line">	rdb := redis.NewClient(&amp;redis.Options&#123;  </span><br><span class="line">		Addr:     <span class="string">&quot;localhost:6379&quot;</span>, <span class="comment">// Redis地址  </span></span><br><span class="line">		Password: <span class="string">&quot;&quot;</span>,               <span class="comment">// 密码（如果有的话）  </span></span><br><span class="line">		DB:       <span class="number">0</span>,                <span class="comment">// 使用默认DB  </span></span><br><span class="line">	&#125;)  </span><br><span class="line">  </span><br><span class="line">	ctx := context.Background()  </span><br><span class="line">  </span><br><span class="line">	<span class="comment">// 创建Stream  </span></span><br><span class="line">	_, err := rdb.XAdd(ctx, &amp;redis.XAddArgs&#123;  </span><br><span class="line">		Stream: <span class="string">&quot;mystream&quot;</span>,  </span><br><span class="line">		Values: <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;  </span><br><span class="line">			<span class="string">&quot;field1&quot;</span>: <span class="string">&quot;value1&quot;</span>,  </span><br><span class="line">			<span class="string">&quot;field2&quot;</span>: <span class="string">&quot;value2&quot;</span>,  </span><br><span class="line">		&#125;,  </span><br><span class="line">	&#125;).Result()  </span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">		log.Fatalf(<span class="string">&quot;Failed to add message to stream: %v&quot;</span>, err)  </span><br><span class="line">	&#125;  </span><br><span class="line">  </span><br><span class="line">	<span class="comment">// 创建Consumer Group  </span></span><br><span class="line">	_, err = rdb.XGroupCreate(ctx, <span class="string">&quot;mystream&quot;</span>, <span class="string">&quot;mygroup&quot;</span>, <span class="string">&quot;$&quot;</span>).Result()  </span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; err != redis.Nil &#123;  </span><br><span class="line">		log.Fatalf(<span class="string">&quot;Failed to create consumer group: %v&quot;</span>, err)  </span><br><span class="line">	&#125;  </span><br><span class="line">  </span><br><span class="line">	<span class="comment">// 消费者读取消息  </span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;  </span><br><span class="line">		<span class="keyword">for</span> &#123;  </span><br><span class="line">			msgs, err := rdb.XReadGroup(ctx, &amp;redis.XReadGroupArgs&#123;  </span><br><span class="line">				Group:    <span class="string">&quot;mygroup&quot;</span>,  </span><br><span class="line">				Consumer: <span class="string">&quot;myconsumer&quot;</span>,  </span><br><span class="line">				Streams:  []<span class="type">string</span>&#123;<span class="string">&quot;mystream&quot;</span>, <span class="string">&quot;&gt;&quot;</span>&#125;,  </span><br><span class="line">				Count:    <span class="number">1</span>,  </span><br><span class="line">				Block:    <span class="number">1000</span>, <span class="comment">// 阻塞1000毫秒  </span></span><br><span class="line">			&#125;).Result()  </span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">				<span class="keyword">if</span> err == redis.Nil &#123;  </span><br><span class="line">					<span class="comment">// 超时，没有新消息  </span></span><br><span class="line">					<span class="keyword">continue</span>  </span><br><span class="line">				&#125;  </span><br><span class="line">				log.Fatalf(<span class="string">&quot;Failed to read from stream: %v&quot;</span>, err)  </span><br><span class="line">			&#125;  </span><br><span class="line">  </span><br><span class="line">			<span class="keyword">for</span> _, msg := <span class="keyword">range</span> msgs[<span class="number">0</span>].Messages &#123;  </span><br><span class="line">				fmt.Printf(<span class="string">&quot;Received: %s %s\n&quot;</span>, msg.ID, msg.Values)  </span><br><span class="line">  </span><br><span class="line">				<span class="comment">// 确认消息  </span></span><br><span class="line">				_, err = rdb.XAck(ctx, <span class="string">&quot;mystream&quot;</span>, <span class="string">&quot;mygroup&quot;</span>, msg.ID).Result()  </span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">					log.Fatalf(<span class="string">&quot;Failed to ack message: %v&quot;</span>, err)  </span><br><span class="line">				&#125;  </span><br><span class="line">			&#125;  </span><br><span class="line">		&#125;  </span><br><span class="line">	&#125;()  </span><br><span class="line">  </span><br><span class="line">	<span class="comment">// 模拟生产者继续发送消息  </span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;  </span><br><span class="line">		_, err := rdb.XAdd(ctx, &amp;redis.XAddArgs&#123;  </span><br><span class="line">			Stream: <span class="string">&quot;mystream&quot;</span>,  </span><br><span class="line">			Values: <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;  </span><br><span class="line">				<span class="string">&quot;field1&quot;</span>: fmt.Sprintf(<span class="string">&quot;value%d&quot;</span>, i+<span class="number">1</span>),  </span><br><span class="line">				<span class="string">&quot;field2&quot;</span>: <span class="string">&quot;another value&quot;</span>,  </span><br><span class="line">			&#125;,  </span><br><span class="line">			MaxLen:     <span class="number">100</span>,  </span><br><span class="line">			Approximate: <span class="literal">true</span>,  </span><br><span class="line">		&#125;).Result()  </span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">			log.Fatalf(<span class="string">&quot;Failed to add message to stream: %v&quot;</span>, err)  </span><br><span class="line">		&#125;  </span><br><span class="line">		time.Sleep(<span class="number">2</span> * time.Second) <span class="comment">// 模拟生产间隔  </span></span><br><span class="line">	&#125;  </span><br><span class="line">  </span><br><span class="line">	<span class="comment">// 注意：在实际应用中，主goroutine通常不会立即退出，而是会等待某些触发条件</span></span><br></pre></td></tr></table></figure>

<h1 id="5-应用场景"><a href="#5-应用场景" class="headerlink" title="5 应用场景"></a>5 应用场景</h1><p><strong>1. 消息队列</strong>：Redis Stream可以作为消息队列使用，支持消息的发布、订阅和消费。</p>
<p><strong>2. 日志记录</strong>：将日志信息写入Redis Stream，方便后续的查询和分析。</p>
<p><strong>3. 实时数据分析</strong>：结合Redis的其他数据结构（如Sorted Set、Hash等），对Stream中的数据进行实时分析。</p>
<h1 id="6-总结"><a href="#6-总结" class="headerlink" title="6 总结"></a>6 总结</h1><p>Redis Stream是Redis在消息队列和流式数据处理领域的一个重要补充，它提供了简单但功能强大的数据流处理能力，为开发者提供了更多的选择和灵活性。相对List，Stream的优势如下：</p>
<ul>
<li>支持消息确认机制（ACK应答确认）</li>
<li>支持消息回溯，方便排查问题和做消息分析</li>
<li>存在消费组（Consumer Group）的概念，可以进行分组消费和批量消费，可以负载多个消费实例</li>
</ul>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAAMCZ7HaLpZxDj_zG1XxJmHwfbAThfQAAqTEMRuvMJFV9E-PLlimPicBAAMCAAN4AAM2BA.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAAMCZ7HaLpZxDj_zG1XxJmHwfbAThfQAAqTEMRuvMJFV9E-PLlimPicBAAMCAAN4AAM2BA.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">dachang</div><div class="post-copyright__author_desc">感谢你选择与我一起虚度时光。</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://yeoh.de5.net/2025/03/11/Redis%E7%B3%BB%E5%88%97/Redis%E7%B3%BB%E5%88%97-%E4%BD%BF%E7%94%A8Stream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%20%EF%BC%88%E5%9B%BE%E6%96%87%E6%80%BB%E7%BB%93+Go%E6%A1%88%E4%BE%8B%EF%BC%89/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://yeoh.de5.net/2025/03/11/Redis%E7%B3%BB%E5%88%97/Redis%E7%B3%BB%E5%88%97-%E4%BD%BF%E7%94%A8Stream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%20%EF%BC%88%E5%9B%BE%E6%96%87%E6%80%BB%E7%BB%93+Go%E6%A1%88%E4%BE%8B%EF%BC%89/')">Redis系列：使用Streams实现消息队列</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://imags-563.pages.dev/file/AgACAgUAAxkDAAMEZ7HheDSuPHt4eDeH2L1Y4ORfslsAArXEMRuvMJFVZbGWT1spGtgBAAMCAAN4AAM2BA.jpg" target="_blank"><img class="post-qr-code-img" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAAMEZ7HheDSuPHt4eDeH2L1Y4ORfslsAArXEMRuvMJFVZbGWT1spGtgBAAMCAAN4AAM2BA.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://imags-563.pages.dev/file/AgACAgUAAxkDAAMFZ7Hh6gSTlGPMvEOEIQjcnW85WsUAArfEMRuvMJFV1ctnAAFzfhv0AQADAgADeAADNgQ.jpg" target="_blank"><img class="post-qr-code-img" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAAMFZ7Hh6gSTlGPMvEOEIQjcnW85WsUAArfEMRuvMJFV1ctnAAFzfhv0AQADAgADeAADNgQ.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://yeoh.de5.net/2025/03/11/Redis%E7%B3%BB%E5%88%97/Redis%E7%B3%BB%E5%88%97-%E4%BD%BF%E7%94%A8Stream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%20%EF%BC%88%E5%9B%BE%E6%96%87%E6%80%BB%E7%BB%93+Go%E6%A1%88%E4%BE%8B%EF%BC%89/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=Redis系列：使用Streams实现消息队列&amp;url=https://yeoh.de5.net/2025/03/11/Redis%E7%B3%BB%E5%88%97/Redis%E7%B3%BB%E5%88%97-%E4%BD%BF%E7%94%A8Stream%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%20%EF%BC%88%E5%9B%BE%E6%96%87%E6%80%BB%E7%BB%93+Go%E6%A1%88%E4%BE%8B%EF%BC%89/&amp;pic=https://imags-563.pages.dev/file/AgACAgUAAxkDAAIBFWlIvNvdTt-H8sSGtUfWAtXH1LFZAAJjDGsbp6dAVpJ4P2lUtyBqAQADAgADeAADNgQ.png" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://yeoh.de5.net" target="_blank">数根朽木，</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/Redis/"><span class="categoryes-punctuation"> <i class="anzhiyufont anzhiyu-icon-inbox"></i></span>Redis<span class="categoryesPageCount">9</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Redis/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Redis<span class="tagsPageCount">9</span></a><a class="post-meta__box__tags" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>消息队列<span class="tagsPageCount">2</span></a></div></div><div class="post_share"><div class="social-share" data-image="https://imags-563.pages.dev/file/AgACAgUAAxkDAAIBIGlI0g4Ii62Xne22N4th4UMPrS0DAAIHDWsbp6dAVnNCxOKsiF6pAQADAgADdwADNgQ.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/03/11/Redis%E7%B3%BB%E5%88%97/Redis%E7%B3%BB%E5%88%97-%E5%86%85%E5%AD%98%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5/"><img class="prev-cover" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAAOCaUJyji-IMAZryUvzqam01QmRvs8AAtoLaxvvjBBWGHkoVtjkPrkBAAMCAAN3AAM2BA.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Redis系列：内存淘汰策略</div></div></a></div><div class="next-post pull-right"><a href="/2025/03/11/Redis%E7%B3%BB%E5%88%97/Redis%E7%B3%BB%E5%88%97-%E4%BD%BF%E7%94%A8List%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"><img class="next-cover" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAANlaUIziU-Bsh9lbn9JNmBQLD0O0WkAAmkLaxvvjBBW98Yxo9My5IUBAAMCAAN4AAM2BA.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Redis系列：使用List实现消息队列</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2025/03/11/Redis%E7%B3%BB%E5%88%97/Redis%E7%B3%BB%E5%88%97-%E4%BD%BF%E7%94%A8List%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" title="Redis系列：使用List实现消息队列"><img class="cover" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAANlaUIziU-Bsh9lbn9JNmBQLD0O0WkAAmkLaxvvjBBW98Yxo9My5IUBAAMCAAN4AAM2BA.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-03-11</div><div class="title">Redis系列：使用List实现消息队列</div></div></a></div><div><a href="/2025/05/01/Redis%E7%B3%BB%E5%88%97/Redis%E7%B3%BB%E5%88%97-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/" title="Redis系列：分布式锁实现"><img class="cover" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAAIBGWlIwzKabW81Nl_xUH07BaIMsxxVAAKHDGsbp6dAVkaNUsXiJ7akAQADAgADdwADNgQ.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-05-01</div><div class="title">Redis系列：分布式锁实现</div></div></a></div><div><a href="/2025/05/01/Redis%E7%B3%BB%E5%88%97/Redis%E7%B3%BB%E5%88%97-%E8%BF%87%E6%9C%9F%E6%95%B0%E6%8D%AE%E7%9A%84%E5%88%A0%E9%99%A4%E7%AD%96%E7%95%A5/" title="Redis系列：过期数据的删除策略"><img class="cover" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAAIBF2lIv3_sqwwzcZoQ0CD6CAQ5Oso3AAJnDGsbp6dAVhuyNGsqQvLzAQADAgADdwADNgQ.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-05-01</div><div class="title">Redis系列：过期数据的删除策略</div></div></a></div><div><a href="/2025/04/16/Redis%E7%B3%BB%E5%88%97/Redis%E7%B3%BB%E5%88%97-%E4%BD%BF%E7%94%A8%E8%A7%84%E8%8C%83/" title="Redis系列：使用规范"><img class="cover" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAAIBBGlIrI_XPG_wdeezX5Rp3_l7NVGjAALuC2sbp6dAVjmPGsa83AnGAQADAgADeAADNgQ.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-04-16</div><div class="title">Redis系列：使用规范</div></div></a></div><div><a href="/2025/03/20/Redis%E7%B3%BB%E5%88%97/Redis%E7%B3%BB%E5%88%97-%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8(%E5%8E%9F%E7%90%86)/" title="Redis系列：聊聊布隆过滤器"><img class="cover" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAAOVaUNssHJpyoSvULXJ3mpEoLYGqToAAogLaxvvjBhWKAb4Q2NXvCABAAMCAAN3AAM2BA.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-03-20</div><div class="title">Redis系列：聊聊布隆过滤器</div></div></a></div><div><a href="/2025/03/20/Redis%E7%B3%BB%E5%88%97/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E5%8E%9F%E7%90%86/" title="聊聊布隆过滤器（原理）"><img class="cover" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAAOWaUNtQYKc-Drv_7naPYGp3xRUEl0AAokLaxvvjBhWQ2K1g3YGEk8BAAMCAAN5AAM2BA.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-03-20</div><div class="title">聊聊布隆过滤器（原理）</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%85%88%E5%AF%BC"><span class="toc-number">1.</span> <span class="toc-text">1 先导</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%85%B3%E4%BA%8EStream"><span class="toc-number">2.</span> <span class="toc-text">2 关于Stream</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E4%B8%BB%E8%A6%81%E5%91%BD%E4%BB%A4"><span class="toc-number">3.</span> <span class="toc-text">3 主要命令</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-XADD-%E6%B6%88%E6%81%AF%E8%AE%B0%E5%BD%95"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 XADD 消息记录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-XADD-%E5%91%BD%E4%BB%A4%E7%9A%84%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">3.1.1.</span> <span class="toc-text">3.1.1 XADD 命令的基本语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-XADD-%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.1.2.</span> <span class="toc-text">3.1.2 XADD 示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-3-%E6%9C%89%E5%95%A5%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E5%91%A2"><span class="toc-number">3.1.3.</span> <span class="toc-text">3.1.3 有啥需要注意的呢</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-XREAD-%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 XREAD 消息消费</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-XREAD-%E5%91%BD%E4%BB%A4%E7%9A%84%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">3.2.1.</span> <span class="toc-text">3.2.1 XREAD 命令的基本语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-XREAD-%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.2.2.</span> <span class="toc-text">3.2.2 XREAD 示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E5%95%A5%E5%91%A2%EF%BC%9F"><span class="toc-number">3.2.3.</span> <span class="toc-text">3.2.3 需要注意啥呢？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-Consumer-Group-%E6%B6%88%E8%B4%B9%E7%BB%84%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 Consumer Group 消费组模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-%E5%88%9B%E5%BB%BA%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84"><span class="toc-number">3.3.1.</span> <span class="toc-text">3.3.1 创建消费者组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-%E8%AF%BB%E5%8F%96%E6%B6%88%E6%81%AF"><span class="toc-number">3.3.2.</span> <span class="toc-text">3.3.2 读取消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3-%E7%A1%AE%E8%AE%A4%E6%B6%88%E6%81%AF"><span class="toc-number">3.3.3.</span> <span class="toc-text">3.3.3 确认消息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-4-PLE%EF%BC%9A%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E6%80%A7%E4%BF%9D%E9%9A%9C"><span class="toc-number">3.3.4.</span> <span class="toc-text">3.3.4 PLE：消息可靠性保障</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E4%BD%BF%E7%94%A8Golang%E5%AE%9E%E7%8E%B0Stream%E9%98%9F%E5%88%97%E8%83%BD%E5%8A%9B"><span class="toc-number">4.</span> <span class="toc-text">4 使用Golang实现Stream队列能力</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E5%85%88%E5%AE%89%E8%A3%85go-redis-redis%E5%BA%93"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 先安装go-redis&#x2F;redis库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.2.</span> <span class="toc-text">逻辑实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">5.</span> <span class="toc-text">5 应用场景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">6 总结</span></a></li></ol></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:youngyang0220@gmail.com" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0, 500)" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAAMCZ7HaLpZxDj_zG1XxJmHwfbAThfQAAqTEMRuvMJFV9E-PLlimPicBAAMCAAN4AAM2BA.jpg" size="50px"/><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/dachang007" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div><div id="anzhiyu-footer"><div class="footer-group"><div class="footer-title">服务</div><div class="footer-links"><a class="footer-item" title="51la统计" target="_blank" rel="noopener" href="https://v6.51.la/">51la统计</a><a class="footer-item" title="十年之约" target="_blank" rel="noopener" href="https://www.foreverblog.cn/">十年之约</a><a class="footer-item" title="开往" target="_blank" rel="noopener" href="https://github.com/travellings-link/travellings">开往</a></div></div><div class="footer-group"><div class="footer-title">主题</div><div class="footer-links"><a class="footer-item" title="文档" target="_blank" rel="noopener" href="https://docs.anheyu.com/">文档</a><a class="footer-item" title="源码" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu">源码</a><a class="footer-item" title="更新日志" href="/update/">更新日志</a></div></div><div class="footer-group"><div class="footer-title">导航</div><div class="footer-links"><a class="footer-item" title="图床工具" target="_blank" rel="noopener" href="https://imags-563.pages.dev">图床工具</a><a class="footer-item" title="在线烟花模拟器" target="_blank" rel="noopener" href="http://greatree.hidns.co">在线烟花模拟器</a><a class="footer-item" title="订阅转换" target="_blank" rel="noopener" href="https://suburl.v1.mk">订阅转换</a><a class="footer-item" title="在线简历生成" target="_blank" rel="noopener" href="https://imags-563.pages.dev">在线简历生成</a></div></div><div class="footer-group"><div class="footer-title-group"><div class="footer-title">友链</div><a class="random-friends-btn" id="footer-random-friends-btn" href="javascript:addFriendLinksInFooter();" title="换一批友情链接"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i></a></div><div class="footer-links" id="friend-links-in-footer"></div></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title="博客框架为Hexo_v5.4.0"><img src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v5.4.0"/></a><a class="github-badge" target="_blank" href="https://blog.anheyu.com/" style="margin-inline:5px" data-title="本站使用AnZhiYu主题" title="本站使用AnZhiYu主题"><img src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.9/img/Theme-AnZhiYu-2E67D3.svg" alt="本站使用AnZhiYu主题"/></a><a class="github-badge" target="_blank" href="https://www.Cloudflare.com/" style="margin-inline:5px" data-title="本站使用CloudFlare为静态资源提供CDN加速" title="本站使用CloudFlare为静态资源提供CDN加速"><img src="https://img.shields.io/badge/%E2%98%81CDN-CloudFlare-yellow" alt="本站使用CloudFlare为静态资源提供CDN加速"/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title="本站项目由Github托管"><img src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" alt="本站项目由Github托管"/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/Copyright-BY-NC-SA.svg" alt="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"/></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2022 - 2025 By <a class="footer-bar-link" href="/" title="dachang" target="_blank">dachang</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType () {
  fetch('https://v1.hitokoto.cn')
    .then(response => response.json())
    .then(data => {
      if (false) {
        const from = '出自 ' + data.from
        const sub = []
        sub.unshift(data.hitokoto, from)
        window.typed = new Typed('#footer-type-tips', {
          strings: sub,
          startDelay: 300,
          typeSpeed: 150,
          loop: false,
          backSpeed: 50,
        })
      } else {
        document.getElementById('footer-type-tips').innerHTML = data.hitokoto
      }
    })
}

if (false) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://cdn.cbd.int/typed.js@2.1.0/dist/typed.umd.js').then(subtitleType)
  }
} else {
  subtitleType()
}
</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">47</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">37</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">9</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网站项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://imags-563.pages.dev" title="个人博客"><img class="back-menu-item-icon" src="/favicon.ico" alt="个人博客"/><span class="back-menu-item-text">个人博客</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://imags-563.pages.dev" title="在线简历"><img class="back-menu-item-icon" src="/favicon.ico" alt="在线简历"/><span class="back-menu-item-text">在线简历</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">建设工具</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://imags-563.pages.dev" title="在线图床"><img class="back-menu-item-icon" src="/img/image.ico" alt="在线图床"/><span class="back-menu-item-text">在线图床</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="http://greatree.hidns.co" title="在线烟花模拟器"><img class="back-menu-item-icon" src="/img/Clash.Mini.png" alt="在线烟花模拟器"/><span class="back-menu-item-text">在线烟花模拟器</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="http://greatree.hidns.co" title="烟花模拟器"><img class="back-menu-item-icon" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAAMMZ7Qfv1Xv2qvgqSVN7kNhRO_uzfgAAlvAMRtiZKBVrGT1Z6RPiX4BAAMCAANtAAM2BA.png" alt="烟花模拟器"/><span class="back-menu-item-text">烟花模拟器</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="http://pay.totalh.net/" title="三合一收款码"><img class="back-menu-item-icon" src="https://imags-563.pages.dev/file/AgACAgUAAxkDAAM8Z7WNYNdWdrYsas5PPFT8Di3493sAAgLKMRsEtalVDcfaakgTXPkBAAMCAAN4AAM2BA.png" alt="三合一收款码"/><span class="back-menu-item-text">三合一收款码</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 博客文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 全部文章</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 文章分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 所有标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 网站工具</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://imags-563.pages.dev"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 图床工具</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="http://greatree.hidns.co"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size: 0.9em;"></i><span> 烟花模拟器</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://suburl.v1.mk"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 订阅转换</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://imags-563.pages.dev"><span> 在线简历生成</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于我</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://imags-563.pages.dev"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 在线简历</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Boolean-filter/" style="font-size: 0.88rem;">Boolean filter<sup>2</sup></a><a href="/tags/DNS%E6%B3%84%E9%9C%B2/" style="font-size: 0.88rem;">DNS泄露<sup>1</sup></a><a href="/tags/Fake-IP/" style="font-size: 0.88rem;">Fake IP<sup>1</sup></a><a href="/tags/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 0.88rem;">JVM虚拟机<sup>1</sup></a><a href="/tags/Java/" style="font-size: 0.88rem;">Java<sup>1</sup></a><a href="/tags/JavaSE/" style="font-size: 0.88rem;">JavaSE<sup>11</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">Java基础<sup>11</sup></a><a href="/tags/Java%E6%A0%B8%E5%BF%83/" style="font-size: 0.88rem;">Java核心<sup>14</sup></a><a href="/tags/Java%E7%89%88%E6%9C%AC%E6%96%B0%E7%89%B9%E6%80%A7/" style="font-size: 0.88rem;">Java版本新特性<sup>2</sup></a><a href="/tags/MQ/" style="font-size: 0.88rem;">MQ<sup>2</sup></a><a href="/tags/MySQL/" style="font-size: 0.88rem;">MySQL<sup>10</sup></a><a href="/tags/OOM/" style="font-size: 0.88rem;">OOM<sup>1</sup></a><a href="/tags/RabbitMQ/" style="font-size: 0.88rem;">RabbitMQ<sup>2</sup></a><a href="/tags/Redis/" style="font-size: 0.88rem;">Redis<sup>9</sup></a><a href="/tags/Redis%E5%86%85%E5%AD%98%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5/" style="font-size: 0.88rem;">Redis内存淘汰策略<sup>1</sup></a><a href="/tags/Redis%E5%8E%9F%E7%90%86/" style="font-size: 0.88rem;">Redis原理<sup>1</sup></a><a href="/tags/Redis%E7%BC%93%E5%AD%98/" style="font-size: 0.88rem;">Redis缓存<sup>4</sup></a><a href="/tags/RocketMQ/" style="font-size: 0.88rem;">RocketMQ<sup>2</sup></a><a href="/tags/SSM/" style="font-size: 0.88rem;">SSM<sup>1</sup></a><a href="/tags/Spring/" style="font-size: 0.88rem;">Spring<sup>2</sup></a><a href="/tags/SpringBoot/" style="font-size: 0.88rem;">SpringBoot<sup>1</sup></a><a href="/tags/kafka/" style="font-size: 0.88rem;">kafka<sup>2</sup></a><a href="/tags/%E4%BA%8B%E5%8A%A1/" style="font-size: 0.88rem;">事务<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" style="font-size: 0.88rem;">分布式锁<sup>1</sup></a><a href="/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" style="font-size: 0.88rem;">单例模式<sup>1</sup></a><a href="/tags/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/" style="font-size: 0.88rem;">布隆过滤器<sup>2</sup></a><a href="/tags/%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98/" style="font-size: 0.88rem;">微信支付<sup>1</sup></a><a href="/tags/%E6%8E%A5%E5%8F%A3%E8%B6%85%E6%97%B6/" style="font-size: 0.88rem;">接口超时<sup>1</sup></a><a href="/tags/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 0.88rem;">消息中间件<sup>2</sup></a><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 0.88rem;">消息队列<sup>2</sup></a><a href="/tags/%E7%BA%BF%E4%B8%8A%E4%BA%8B%E6%95%85/" style="font-size: 0.88rem;">线上事故<sup>1</sup></a><a href="/tags/%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF/" style="font-size: 0.88rem;">缓存击穿<sup>2</sup></a><a href="/tags/%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9/" style="font-size: 0.88rem;">缓存雪崩<sup>2</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E4%BC%98%E5%8C%96/" style="font-size: 0.88rem;">网络优化<sup>1</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 0.88rem;">设计模式<sup>1</sup></a><a href="/tags/%E8%BF%90%E7%BB%B4%E8%B0%83%E4%BC%98/" style="font-size: 0.88rem;">运维调优<sup>4</sup></a><a href="/tags/%E9%AB%98%E5%B9%B6%E5%8F%91/" style="font-size: 0.88rem;">高并发<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo-kohl-zeta.vercel.app',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://unpkg.com/twikoo@1.6.44/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo-kohl-zeta.vercel.app',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo-kohl-zeta.vercel.app',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://unpkg.com/twikoo@1.6.44/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404')
  }
})</script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>